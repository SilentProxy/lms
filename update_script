#!/bin/bash

# === Konfiguration ===
LMUTIL="/opt/flexlm/bin/lmutil"
LICENSE_FILE="/opt/flexlm/licenses/license.dat"
OPTIONS_FILE="/opt/flexlm/licenses/license.opt"
NEW_LICENSE="/tmp/new_license.dat"
VENDOR_NAME="mathlm"  # z.B. für MathLM oder anpassen
START_SCRIPT="/opt/flexlm/start_mathlm.sh"
LOGFILE="/opt/flexlm/logs/license_update.log"

# === Logging-Funktion ===
log() {
  echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOGFILE"
}

# === 1. Lizenzen für USER blockieren ===
log "Blockiere neue Lizenzbuchungen in Options-Datei..."
echo "RESERVE ALL USER update_block" >> "$OPTIONS_FILE"
$LMUTIL lmreread -c "$LICENSE_FILE"

# === 2. Aktive Nutzer anzeigen ===
log "Aktive Lizenzen für $VENDOR_NAME:"
$LMUTIL lmstat -c "$LICENSE_FILE" -a | grep -A4 "$VENDOR_NAME"

# Optional: gezielt Sitzungen mit lmremove beenden

# === 3. Nur den Vendor-Daemon stoppen ===
log "Stoppe Vendor Daemon $VENDOR_NAME..."
pkill -f "$VENDOR_NAME"
sleep 3

# === 4. Lizenzdatei sichern und ersetzen ===
log "Backup & Update der Lizenzdatei..."
cp "$LICENSE_FILE" "$LICENSE_FILE.bak.$(date +%F_%H-%M)"
cp "$NEW_LICENSE" "$LICENSE_FILE"

# === 5. Vendor-Daemon neu starten ===
log "Starte Vendor Daemon $VENDOR_NAME neu..."
bash "$START_SCRIPT"

sleep 5

# === 6. Lizenzserver reread ===
log "Führe lmreread aus..."
$LMUTIL lmreread -c "$LICENSE_FILE"

# === 7. Blockierung in options-Datei wieder entfernen ===
log "Entferne temporäre Lizenz-Blockierung..."
sed -i '/RESERVE ALL USER update_block/d' "$OPTIONS_FILE"
$LMUTIL lmreread -c "$LICENSE_FILE"

log "Update abgeschlossen – Vendor Daemon $VENDOR_NAME läuft wieder."
